# 目标
构建一个基于 Cloudflare 生态、阿里云 OSS 和 Gemini API 的智能祝福/拜年照片生成系统。系统接收用户上传的照片（及可选物体），通过“专家团”多模态分析，生成经过美化（大眼、瘦脸、美白等）并带有水印的个性化祝福照片。

# 系统架构与技术栈
1.  **前端 (Frontend)**:
    *   **框架**: React/Vue (部署在 Cloudflare Pages 或 Workers Assets)
    *   **交互**: 图片上传、预览、下载、参数调整
2.  **后端 (Backend)**:
    *   **运行环境**: Cloudflare Workers (Serverless)
    *   **框架**: Hono (推荐) 或原生 Worker 语法
3.  **数据存储 (Storage & Database)**:
    *   **对象存储 (OSS)**: 阿里云 OSS (Aliyun OSS) (用于存储用户原图、中间图、最终生成图)
    *   **数据库**: Cloudflare D1 (SQLite) (用于存储任务状态、图片元数据、用户记录)
4.  **AI 核心 (AI Core)**:
    *   **分析**: `gemini-3-pro-preview` (Multimodal analysis)
    *   **生成**: `gemini-3-pro-image-preview` (Image generation)
5.  **配置管理**:
    *   Cloudflare Dashboard (环境变量、Secrets)

# 核心模块设定

## 1. 专家系统 (Expert System)
系统将初始化一组专家人设（Prompt Templates / System Instructions），存储在代码库的 `prompts/experts/` 目录下，运行时动态加载。
*   **角色构成**:
    *   **视觉分析专家**: 负责评估照片质量、构图、人物特征。
    *   **创意总监**: 负责构思祝福语境、背景风格、节日元素。
    *   **人像精修师**: 负责定义美颜参数（大眼、瘦脸、美白、去皱）和人像一致性。
    *   **法律合规顾问**: 负责审核图片内容安全、版权合规性。
*   **工作机制**: 每次请求时，将相关专家的 System Prompt 注入到 Gemini 的 Context 中，形成“专家会诊”模式。

## 2. 图片处理流 (Image Processing Pipeline)
1.  **会话初始化**: 用户开启新会话时，系统在 OSS 中创建一个唯一的 Session 目录 (e.g., `sessions/{session_id}/`)。该次会话的所有图片（上传原图、中间图、生成图）均存储在此目录下。
2.  **上传与缓存**:
    *   为了保证处理速度，用户上传图片时，Worker 可先将图片保存在**临时目录/内存**中，立即进行后续 AI 分析/生成流程。
    *   同时，Worker 启动一个**后台进程 (ctx.waitUntil)** 将图片异步上传至 OSS 的 Session 目录中。
3.  **分析**: Worker 调用 `gemini-3-pro-preview`，引入“专家团”对图片进行可行性分析。
    *   *输入*: 图片 Buffer/Stream (或临时链接) + 专家 Prompt。
    *   *输出*: JSON 格式报告 (是否可用, 建议, 风格标签)。
4.  **生成**: 若分析通过，调用 `gemini-3-pro-image-preview` 进行生成/重绘。
    *   *要求*: 保持人物ID一致 (Identity Preservation)，应用美颜效果，融合节日背景。
5.  **后处理**:
    *   **水印合成**: 在 Worker 中使用库 (如 `@resvg/resvg-js` 或 `satori`) 或调用图像处理 API 添加水印和 "AI Generated" 标志。
    *   **存储**: 最终生成的图片同样先在临时/内存处理，随后通过**后台进程**异步上传至 OSS Session 目录。

# 详细执行流程
1.  **用户提交**: 用户在前端上传个人照片（必须）和参照物体（可选，如宠物），点击“生成”。
2.  **预处理与存储**:
    *   生成 `session_id`。
    *   后端接收图片流，暂存 Worker 内存或临时目录。
    *   **异步上传**: 使用 `ctx.waitUntil` 将图片上传至 OSS `sessions/{session_id}/original.jpg`。
    *   在 D1 数据库创建任务记录，状态为 `PENDING`，记录 `session_id`。
3.  **AI 评估 (Analysis Phase)**:
    *   系统构建 Prompt，包含视觉分析和合规专家的指令。
    *   调用 `gemini-3-pro-preview` 分析图片 (使用 Buffer 或临时 URL)。
    *   **判定**:
        *   *不通过*: 返回原因（如：人脸不清晰、内容违规），更新 D1 状态为 `FAILED`，前端提示用户。
        *   *通过*: 进入生成阶段，提取图片特征关键词。
4.  **AI 生成 (Generation Phase)**:
    *   系统构建生成 Prompt，包含创意总监和精修师的指令（强调美颜、节日氛围、人物一致性）。
    *   调用 `gemini-3-pro-image-preview` 生成图片。
    *   获取生成结果的 Buffer/Stream。
5.  **合成与交付 (Post-processing & Delivery)**:
    *   后端对生成的图片添加水印（Logo + "AI Generated"）。
    *   **异步上传**: 使用 `ctx.waitUntil` 将最终图片上传至 OSS `sessions/{session_id}/generated.jpg`。
    *   更新 D1 状态为 `COMPLETED`，写入最终图片路径。
    *   **交付**: 前端轮询或收到回调，展示图片。**结果页不提供直接下载链接，而是提供一个按钮，点击后调用浏览器原生能力（如 `a` 标签 `download` 属性或 Blob 下载）保存图片**。

# 数据模型 (D1 Schema 示例)
*   **Tasks Table**:
    *   `id`: UUID
    *   `session_id`: String (New Field, maps to OSS directory)
    *   `user_id`: String (Optional)
    *   `original_image_path`: String (Relative path in OSS, e.g., `sessions/{sid}/orig.jpg`)
    *   `reference_object_path`: String (Optional)
    *   `status`: 'PENDING' | 'ANALYZING' | 'GENERATING' | 'COMPLETED' | 'FAILED'
    *   `generated_image_path`: String
    *   `analysis_result`: JSON (Text)
    *   `created_at`: Timestamp

# 注意事项 (Attention Points)
1.  **异步上传**: 充分利用 Cloudflare Workers 的 `ctx.waitUntil()` 机制处理 OSS 上传，避免阻塞 AI 生成的主流程，提高用户感知的响应速度。
2.  **目录管理**: 确保 Session ID 的唯一性，OSS 目录结构清晰 (`sessions/{session_id}/`)。
3.  **美颜策略**: 在 Prompt 中明确具体的“摄影后期”术语（如 "High-end retouching", "Skin smoothing", "Eye enlargement"），确保模型能理解并执行美化，同时不丢失人物特征。
4.  **水印强制性**: 必须在后端合成水印，防止前端绕过。水印应包含个人品牌标识和 AI 生成提示（符合法律法规要求）。
5.  **隐私保护**: OSS Bucket 权限应设置为私有，仅通过 Worker 签名的临时链接或通过 Worker 代理访问图片。
